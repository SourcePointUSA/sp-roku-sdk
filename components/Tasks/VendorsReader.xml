<?xml version = "1.0" encoding = "utf-8" ?>

<!--********** Copyright 2016 Roku Corp.  All Rights Reserved. **********-->

<component name = "VendorsReader" extends = "Task" >

  <interface>
    <field id = "vendors" type = "node" />
  </interface>

  <script type = "text/brightscript" >

    <![CDATA[

    sub init()
      m.top.functionName = "getPurposes"
    end sub

    sub getPurposes()
      vendors = createObject("roSGNode", "ContentNode")
      vendors.setField("role", "content")
      urlTransferObj = createObject("roUrlTransfer")
      urlTransferObj.SetCertificatesFile("common:/certs/ca-bundle.crt")
      urlTransferObj.AddHeader("X-Roku-Reserved-Dev-Id", "")
      urlTransferObj.InitClientCertificates()
      urlTransferObj.setUrl("https://sourcepoint.mgr.consensu.org/privacy-manager/privacy-manager-view?siteId=" + m.global.site_id)
      pmData = urlTransferObj.GetToString()
      pmJSON = ParseJSON(pmData)
      for each vendor in pmJSON["vendors"]
        vendorNode = vendors.createChild("ContentNode")
        vendorNode.setField("title", vendor.name)
        vendorNode.setField("id", vendor._id)
        purposesString = ""
        legIntString = ""
        for each purpose in vendor.purposes
          purposesString = purposesString + "*  " + purpose + chr(10)
        end for
        for each legIntPurpose in vendor.legIntPurposes
          legIntString = legIntString + "*  " + legIntPurpose + chr(10)
        end for
        finalPurposeString = purposesString + "^" + legIntString
        vendorNode.setField("description", finalPurposeString)
      end for
      m.top.vendors = vendors
    end sub


    ]]>

  </script>

</component>
