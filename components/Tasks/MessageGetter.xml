<?xml version = "1.0" encoding = "utf-8" ?>

<component name = "MessageGetter" extends = "Task" >

  <interface>
    <field id = "message" type = "string" />
    <field id = "consentData" type = "string" />
  </interface>

  <script type = "text/brightscript" >

    <![CDATA[
        sub init()
          m.top.functionName = "getMessage"
        end sub

        function getAuthData() as dynamic
          sec = CreateObject("roRegistrySection", "Authentication")
          if sec.exists("loggedInUser")
            ' check for invalid here
            return sec.read("resolvedConsentUUID")
          else 
            urlTransferObj = createObject("roUrlTransfer")
            di = CreateObject("roDeviceInfo")
            consentUUID = urlTransferObj.escape(di.GetRIDA())
            return consentUUID
          end if
        end function

        sub getMessage()
          consentData = m.top.consentData
          loadedData = consentData.Replace(Chr(34), "\" + Chr(34))
          message = createObject("roSGNode", "ContentNode")
          urlTransferObj = createObject("roUrlTransfer")
          urlTransferObj.SetCertificatesFile("common:/certs/ca-bundle.crt")
          urlTransferObj.AddHeader("X-Roku-Reserved-Dev-Id", "")
          urlTransferObj.InitClientCertificates()
          ' Here we want to first check to see if the user is logged in -> query for loggedInUser from the registry
          ' If null, we want to send the deviceID as the consentUUID.
          ' If the user is loggedIn, we want to send the resolvedConsentUUID as the consentUUID
          consentUUID = getAuthData()
          loadedDataEncoded = urlTransferObj.UrlEncode(loadedData)
          url = "https://mms.sp-prod.net/mms/get_site_js?v=1&account_id=22&abp=false&referrer=&session_referrer=&session_message_count=1&jv=2.0.1115&cdc=window._sp_.msg._internal.cdc1&href=https%3A%2F%2Fcbs.allaccess.ott%2Fen_uk%3F_sp_debug_level%3Ddebug&consentUUID=" + consentUUID + "&cookie=%5B%22_sp_enable_dfp_personalized_ads%3Dfalse%3B%22%5D&loadedData=%5B%7B%22id%22%3A%22CONSENT%3Aendpoint%3Ahttps%3A%2F%2Fsourcepoint.mgr.consensu.org%3A" + m.global.site_id + "%22%2C%22result%22%3A%22" + loadedDataEncoded + "%22%7D%5D"
          urlTransferObj.setUrl(url)
          message = urlTransferObj.GetToString()
          m.top.message = message
        end sub
    ]]>

  </script>

</component>
