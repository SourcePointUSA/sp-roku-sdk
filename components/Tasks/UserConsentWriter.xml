<?xml version = "1.0" encoding = "utf-8" ?>

<component name = "UserConsentSetter" extends = "Task" >

  <interface>
    <field id = "userConsentJSONBody" type = "string" />
  </interface>

  <script type = "text/brightscript" >

    <![CDATA[

    sub init()
      m.top.functionName = "setConsent"
    end sub

    function getAuthData() as dynamic
      sec = CreateObject("roRegistrySection", "Authentication")
      if sec.exists("loggedInUser")
        ' check for invalid here
        return sec.read("resolvedConsentUUID")
      else 
        urlTransferObj = createObject("roUrlTransfer")
        di = CreateObject("roDeviceInfo")
        consentUUID = urlTransferObj.escape(di.GetRIDA())
        return consentUUID
      end if
    end function

    sub setConsent()
      consent = createObject("roSGNode", "ContentNode")
      readInternet = createObject("roUrlTransfer")
      readInternet.SetCertificatesFile("common:/certs/ca-bundle.crt")
      readInternet.AddHeader("X-Roku-Reserved-Dev-Id", "")
      readInternet.InitClientCertificates()
      
      di = CreateObject("roDeviceInfo")
      consentUUID = getAuthData()
      siteid = m.top.siteid
      url = "https://sourcepoint.mgr.consensu.org/consent/v2/" + m.global.site_id + "?consentUUID=" + consentUUID + "&privacyManagerId=" + m.global.privacy_manager_id

      readInternet.AddHeader("Content-Type", "application/json")
      readInternet.AddHeader("Accept", "application/json")
      readInternet.setUrl(url)
      response = readInternet.PostFromString(m.top.userConsentJSONBody)
    end sub


    ]]>

  </script>

</component>
  