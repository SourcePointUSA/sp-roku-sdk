<?xml version = "1.0" encoding = "utf-8" ?>

<!--********** Copyright 2016 Roku Corp.  All Rights Reserved. **********-->

<component name = "VendorReader" extends = "Task" >

  <interface>
    <field id = "content" type = "node" />
    <field id = "category" type = "string" />
  </interface>

  <script type = "text/brightscript" >

    <![CDATA[

    sub init()
      m.top.functionName = "getPurposes"
    end sub

    sub getPurposes()
      vendors = createObject("roSGNode", "ContentNode")
      vendors.setField("role", "content")
      urlTransferObj = createObject("roUrlTransfer")
      urlTransferObj.SetCertificatesFile("common:/certs/ca-bundle.crt")
      urlTransferObj.AddHeader("X-Roku-Reserved-Dev-Id", "")
      urlTransferObj.InitClientCertificates()
      urlTransferObj.setUrl("https://sourcepoint.mgr.consensu.org/privacy-manager/privacy-manager-view?siteId=" + m.global.site_id)
      purposeData = urlTransferObj.GetToString()
      purposesJSON = ParseJSON(purposeData)
      for each category in purposesJSON["categories"]
        if category["name"] = m.top.category
            for each vendor in category["requiringConsentVendors"]
                vendorNode = vendors.createChild("ContentNode")
                vendorNode.setField("title", vendor["name"])
                vendorNode.setField("id", vendor._id)
                vendorNode.setField("hideicon", false)
            end for
        end if
      end for
      m.top.content = vendors
    end sub


    ]]>

  </script>

</component>
