<?xml version = "1.0" encoding = "utf-8" ?>

<!--********** Copyright 2016 Roku Corp.  All Rights Reserved. **********-->

<component name = "PurposeReader" extends = "Task" >

  <interface>
    <field id = "content" type = "node" />
    <field id = "purposeVendorMap" type = "assocarray" />
  </interface>

  <script type = "text/brightscript" >

    <![CDATA[

    sub init()
      m.top.functionName = "getPurposes"
    end sub

    sub getPurposes()
      purposes = createObject("roSGNode", "ContentNode")
      urlTransferObj = createObject("roUrlTransfer")
      urlTransferObj.SetCertificatesFile("common:/certs/ca-bundle.crt")
      urlTransferObj.AddHeader("X-Roku-Reserved-Dev-Id", "")
      urlTransferObj.InitClientCertificates()
      urlTransferObj.setUrl("https://sourcepoint.mgr.consensu.org/privacy-manager/privacy-manager-view?siteId=" + m.global.site_id)
      purposesJSON = ParseJSON(urlTransferObj.GetToString())
      purposeVendorMap = createObject("roAssociativeArray")
      for each category in purposesJSON["categories"]
        categoryNode = purposes.createChild("ContentNode")
        categoryNode.setField("title", category["name"])
        categoryNode.setField("description", category["description"])
        categoryNode.setField("id", category._id)
        purposeVendorMap.addReplace(category._id, category.requiringConsentVendors)
      end for
      m.top.content = purposes
      m.top.purposeVendorMap = purposeVendorMap
    end sub


    ]]>

  </script>

</component>
