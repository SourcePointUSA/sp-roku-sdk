<?xml version = "1.0" encoding = "utf-8" ?>

<component name = "UserConsentReader" extends = "Task" >

  <interface>
    <field id = "userconsentData" type = "string" />
  </interface>

  <script type = "text/brightscript" >

    <![CDATA[
        sub init()
            m.top.functionName = "getuserconsentData"
        end sub

        function getAuthData() as dynamic
          sec = CreateObject("roRegistrySection", "Authentication")
          if sec.exists("loggedInUser")
            ' check for invalid here
            return sec.read("resolvedConsentUUID")
          else 
            urlTransferObj = createObject("roUrlTransfer")
            di = CreateObject("roDeviceInfo")
            consentUUID = urlTransferObj.escape(di.GetRIDA())
            return consentUUID
          end if
        end function

        sub getuserconsentData()
            consentData = createObject("roSGNode", "ContentNode")
            urlTransferObj = createObject("roUrlTransfer")
            urlTransferObj.SetCertificatesFile("common:/certs/ca-bundle.crt")
            urlTransferObj.AddHeader("X-Roku-Reserved-Dev-Id", "")
            urlTransferObj.InitClientCertificates()
            consentUUID = getAuthData()
            url = "https://sourcepoint.mgr.consensu.org/consent/v2/" + m.global.site_id + "/?consentUUID=" + consentUUID
            urlTransferObj.setUrl(url)
            consentData = urlTransferObj.GetToString()         
            m.top.userconsentData = consentData
        end sub
    ]]>

  </script>

</component>
